<?xml version="1.0" encoding="utf-8" ?>
<pages:AuthPage
    x:Name="Root"
    x:Class="MedReminder.Pages.Desktop.MedicationOrdersPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:pages="clr-namespace:MedReminder.Pages"
    xmlns:vm="clr-namespace:MedReminder.ViewModels"
    Title="Orders"
    BackgroundColor="{StaticResource Medication_Main_Background}">

    <!-- Optional: if you want compiled bindings, uncomment and set the correct type -->
    <!-- x:DataType="vm:MedicationOrdersViewModel" -->

    <Grid Padding="16" RowDefinitions="Auto,*" RowSpacing="12">

        <!-- Top bar -->
        <!-- Option B: Grid so ActivityIndicator stays pinned right -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12" VerticalOptions="Center">

            <HorizontalStackLayout Grid.Column="0" Spacing="8" VerticalOptions="Center">

                <!-- Refresh -->
                <Border StrokeThickness="0" HeightRequest="28"
                        BackgroundColor="{StaticResource Button_Icon_Background}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="4"/>
                    </Border.StrokeShape>

                    <Grid ColumnDefinitions="32,Auto" Margin="0" InputTransparent="True">
                        <Image Grid.Column="0" Source="icons8_refresh_100.png"
                               HeightRequest="16" WidthRequest="16"
                               HorizontalOptions="Center" VerticalOptions="Center"/>
                        <Border Grid.Column="1"
                                BackgroundColor="{StaticResource Button_View}"
                                Padding="10,0" StrokeThickness="0"
                                InputTransparent="True">
                            <Label Text="REFRESH"
                                   TextColor="{StaticResource Button_Font_Primary}"
                                   FontSize="12"
                                   VerticalOptions="Center"
                                   FontAttributes="Bold"/>
                        </Border>
                    </Grid>

                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding RefreshCommand}"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- Cancel -->
                <Border StrokeThickness="0" HeightRequest="28"
                        BackgroundColor="{StaticResource Button_Icon_Background}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="4"/>
                    </Border.StrokeShape>

                    <Grid ColumnDefinitions="32,Auto" Margin="0" InputTransparent="True">
                        <Image Grid.Column="0" Source="icons8_close_100.png"
                               HeightRequest="16" WidthRequest="16"
                               HorizontalOptions="Center" VerticalOptions="Center"/>
                        <Border Grid.Column="1"
                                BackgroundColor="{StaticResource Button_Cancel}"
                                Padding="10,0" StrokeThickness="0"
                                InputTransparent="True">
                            <Label Text="CANCEL"
                                   TextColor="{StaticResource Button_Cancel_Font}"
                                   FontSize="12"
                                   VerticalOptions="Center"
                                   FontAttributes="Bold"/>
                        </Border>
                    </Grid>

                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnCloseClicked"/>
                    </Border.GestureRecognizers>
                </Border>

                <!-- New Order -->
                <Border StrokeThickness="0" HeightRequest="28"
                        BackgroundColor="{StaticResource Button_Icon_Background}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="4"/>
                    </Border.StrokeShape>

                    <Grid ColumnDefinitions="32,Auto" Margin="0" InputTransparent="True">
                        <Image Grid.Column="0" Source="icons8_add_100.png"
                               HeightRequest="16" WidthRequest="16"
                               HorizontalOptions="Center" VerticalOptions="Center"/>
                        <Border Grid.Column="1"
                                BackgroundColor="{StaticResource Button_Create}"
                                Padding="10,0" StrokeThickness="0"
                                InputTransparent="True">
                            <Label Text="NEW ORDER"
                                   TextColor="{StaticResource Button_Create_Font}"
                                   FontSize="12"
                                   VerticalOptions="Center"
                                   FontAttributes="Bold"/>
                        </Border>
                    </Grid>

                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnNewOrderClicked"/>
                    </Border.GestureRecognizers>
                </Border>

            </HorizontalStackLayout>

            <ActivityIndicator Grid.Column="1"
                               IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}"
                               VerticalOptions="Center"/>
        </Grid>

        <!-- Orders list -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Orders}"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Grid Padding="24">
                    <VerticalStackLayout Spacing="8" HorizontalOptions="Center" VerticalOptions="Center">
                        <Label Text="No orders yet"
                               FontAttributes="Bold"
                               FontSize="16"
                               TextColor="{StaticResource Text_Primary}"/>
                        <Label Text="Click NEW ORDER to create one."
                               FontSize="13"
                               TextColor="{StaticResource Text_Secondary}"/>
                    </VerticalStackLayout>
                </Grid>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <!-- If you have a specific row type, set x:DataType="model:MedicationOrderRow" -->
                <DataTemplate>
                    <Border Padding="14"
                            Margin="0,0,0,12"
                            BackgroundColor="White">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Border.Stroke>
                            <SolidColorBrush Color="#78290F"/>
                        </Border.Stroke>

                        <Grid RowDefinitions="Auto,Auto,Auto"
                              ColumnDefinitions="*,Auto"
                              RowSpacing="10"
                              ColumnSpacing="12">

                            <!-- Header -->
                            <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="2">
                                <Label Text="{Binding MedName}"
                                       FontAttributes="Bold"
                                       FontSize="16"
                                       TextColor="#78290F"/>
                                <Label Text="{Binding Supplier}"
                                       FontSize="12"
                                       TextColor="{StaticResource Text_Secondary}"/>
                            </VerticalStackLayout>

                            <!-- Status pill -->
                            <Border Grid.Row="0" Grid.Column="1"
                                    Padding="10,4"
                                    StrokeThickness="0"
                                    BackgroundColor="{StaticResource Button_Icon_Background}"
                                    HorizontalOptions="End"
                                    VerticalOptions="Start">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="999"/>
                                </Border.StrokeShape>
                                <Label Text="{Binding Status}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Text_Primary}"/>
                            </Border>

                            <!-- Meta row -->
                            <Grid Grid.Row="1" Grid.ColumnSpan="2"
                                  ColumnDefinitions="Auto,*,Auto"
                                  ColumnSpacing="10">

                                <Label Grid.Column="0"
                                       Text="Qty:"
                                       FontAttributes="Bold"
                                       FontSize="12"
                                       TextColor="{StaticResource Text_Primary}"
                                       VerticalOptions="Center"/>

                                <Label Grid.Column="1"
                                       Text="{Binding Quantity}"
                                       FontSize="12"
                                       TextColor="{StaticResource Text_Primary}"
                                       VerticalOptions="Center"/>

                                <Label Grid.Column="2"
                                       Text="{Binding CreatedAt}"
                                       FontSize="12"
                                       TextColor="{StaticResource Text_Secondary}"
                                       VerticalOptions="Center"
                                       HorizontalOptions="End"/>
                            </Grid>

                            <!-- Notes -->
                            <Label Grid.Row="2" Grid.ColumnSpan="2"
                                   Text="{Binding Notes}"
                                   FontSize="12"
                                   TextColor="{StaticResource Text_Secondary}"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="2"
                                   IsVisible="{Binding Notes, Converter={StaticResource StringNotEmptyConverter}}"/>

                            <!-- Action buttons row -->
                            <Grid Grid.Row="3" Grid.ColumnSpan="2"
                                  ColumnDefinitions="Auto,Auto,Auto,*"
                                  ColumnSpacing="8"
                                  RowSpacing="0">

                                <!-- Approve -->
                                <Border Grid.Column="0"
                                        StrokeThickness="0"
                                        HeightRequest="26"
                                        BackgroundColor="{StaticResource Button_Icon_Background}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6"/>
                                    </Border.StrokeShape>
                                    <Grid ColumnDefinitions="Auto" Padding="10,0" InputTransparent="True">
                                        <Label Text="APPROVE"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               TextColor="{StaticResource Button_Font_Primary}"/>
                                    </Grid>
                                    <Border.GestureRecognizers>
                                        <!-- If you use commands per item, bind them here -->
                                        <TapGestureRecognizer
                                            Command="{Binding Source={x:Reference Root}, Path=BindingContext.ApproveOrderCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                </Border>

                                <!-- Receive -->
                                <Border Grid.Column="1"
                                        StrokeThickness="0"
                                        HeightRequest="26"
                                        BackgroundColor="{StaticResource Button_Icon_Background}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6"/>
                                    </Border.StrokeShape>
                                    <Grid ColumnDefinitions="Auto" Padding="10,0" InputTransparent="True">
                                        <Label Text="RECEIVE"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               TextColor="{StaticResource Button_Font_Primary}"/>
                                    </Grid>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={x:Reference Root}, Path=BindingContext.ReceiveOrderCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                </Border>

                                <!-- Cancel order -->
                                <Border Grid.Column="2"
                                        StrokeThickness="0"
                                        HeightRequest="26"
                                        BackgroundColor="{StaticResource Button_Icon_Background}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="6"/>
                                    </Border.StrokeShape>
                                    <Grid ColumnDefinitions="Auto" Padding="10,0" InputTransparent="True">
                                        <Label Text="VOID"
                                               FontSize="11"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               TextColor="{StaticResource Button_Cancel_Font}"/>
                                    </Grid>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={x:Reference Root}, Path=BindingContext.VoidOrderCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                </Border>

                                <!-- Spacer -->
                                <BoxView Grid.Column="3" Opacity="0"/>
                            </Grid>

                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

    </Grid>
</pages:AuthPage>
